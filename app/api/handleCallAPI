import { getCsrfToken, getSession } from "next-auth/react";

// Development
// const BASE_URL = "http://127.0.0.1:8000/hc/";
// Production
const BASE_URL = "https://hc-utils-api.herokuapp.com/hc/";

export async function handleGet(url, params) {
    const csrfToken = await getCsrfToken();
    if (!csrfToken) {
        return { error: "Failed to get CSRF token." };
    }

    // The Token ID has been manually added on the session
    const session = await getSession();
    console.log(session);
    // @ts-ignore
    const token = session?.id_token;
    if (!token) {
        return { error: "Failed to get Google token." };
    }

    // Prepare parameters to be sent on the get call
    let paramsString = "";
    if (params) {
        paramsString = "?";
        for (const [key, value] of Object.entries(params)) {
            paramsString += `${key}=${value}&`;
        }
        paramsString = paramsString.slice(0, -1);
    }

    try {
        const response = await fetch(BASE_URL + url + paramsString, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
                Authorization: "Bearer " + token,
            },
        });

        if (response.ok) {
            const responseData = await response.json();
            return responseData;
        } else {
            return { error: "Failed to make the GET request." };
        }
    } catch (error) {
        return { error: "An error occurred while making the GET request." };
    }
}

export async function handleAPI(url, data, method) {
    const csrfToken = await getCsrfToken();
    if (!csrfToken) {
        return { error: "Failed to get CSRF token." };
    }

    // The Token ID has been manually added on the session
    const session = await getSession();
    console.log(session);
    // @ts-ignore
    const token = session?.id_token;
    if (!token) {
        return { error: "Failed to get Google token." };
    }

    try {
        const response = await fetch(BASE_URL + url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
                Authorization: "Bearer " + token,
            },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            const responseData = await response.json();
            return responseData;
        } else {
            return { error: "Failed to make the POST request." };
        }
    } catch (error) {
        return { error: "An error occurred while making the POST request." };
    }
}
